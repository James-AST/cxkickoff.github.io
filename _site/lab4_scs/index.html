<h1 id="lab-4-malicious-package-detection">Lab 4: Malicious Package Detection</h1>
<p>In this lab, we will explore some examples of Software Supply Chain (SCS) vulnerabilities, and how to remediate them.</p>

<h2 id="prerequisites">Prerequisites</h2>
<p>We will be using our <strong>totallysecureapp</strong> project, which is available at https://github.com/cxworkshops/totallysecureapp. If you have not already done so, clone the project to your local machine, as defined in <a href="../lab1_setup/">Lab 1</a>.</p>

<p class="note">While we are reviewing malicious packages in this lab, we won’t be executing any of the project code (and for that matter, even if you did run the project, the malicious packages aren’t actually used within the project), so there is no risk of introducing malicious packages into your system.</p>

<h2 id="introduction">Introduction</h2>
<p>A good developer is an efficient developer and part of being an efficient developer is not re-inventing the wheel for every project or solution.  As a result, many of us leverage the benefits of freely available open source software and/or packages to save time and effort and let us achieve our functionality and features faster. And while these open source solutions save significant time, effort, and headaches, importing others’ code into our projects exposes us to potential risks and vulnerabilities we otherwise wouldn’t face if we developed all of our code ourselves.</p>

<h2 id="reviewing-scs-results">Reviewing SCS Results</h2>
<p>SCS results are included in the Checkmarx SCA scan engine.  Within the Checkmarx VS Code plugin, ensure you are connected to the project, branch, and scan result as noted in the <strong>Connect to a project</strong> section in <a href="../lab1_setup/">Lab 1</a>.</p>

<h3 id="typosquatting">TypoSquatting</h3>

<ol>
  <li>
    <p>Navigate to the Checkmarx Plugin in the left menu of VS Code, expand the sca results, and HIGH results</p>

    <p class="note">SCS Malicious Packages will always be returned in SCA HIGH results</p>

    <p><img src="./assets/images/sca_high_results.png" alt="SCA High Results" title="SCA High Results" /></p>
  </li>
  <li>
    <p>Expand the Npm-momnet-2.29.1 result, and select the <strong>Cxa45b0853-bee2</strong> result. Note how a new pane opens at the far right with a description of the malicious package.</p>

    <p><img src="./assets/images/Cxa45b0853-bee2.png" alt="Cxa45b0853-bee2" title="Cxa45b0853-bee2" /></p>

    <p class="note">Note that to date, unlike vulnerabilities where we have a common standard of CVE, there is no standardized universal ID for malicious packages. For example, IDs of the same incident:</p>
    <ul>
      <li>cx-2021-b8833-be2146 (Checkmarx)</li>
      <li>SNYK-JS-RC-1911120 (Snyk)</li>
      <li>sonatype-2021-1696 (Sonatype)</li>
      <li>GHSA-g2q5-5433-rhrf (GitHub)</li>
    </ul>
  </li>
  <li>
    <p>Per the malicious package description, we can see this is a malicious package and is using the <strong>Typo Squatting</strong> attack.  The package creators are hoping that a developer mistypes “moment” and accidentally imports their package instead, which includes a malicious method that deletes the inner HTML body and crashes the app.  We can fix this malicious package by clicking on the Vulnerable package path which links to package.json and changing the package name from <strong>momnet</strong> to <strong>moment</strong>:</p>

    <p><img src="./assets/images/momnet.png" alt="momnet" title="momnet" /></p>
  </li>
</ol>

<h3 id="repojacking">RepoJacking</h3>

<ol>
  <li>
    <p>Within the Checkmarx Plugin, under the sca &gt; HIGH results, expand the <strong>Npm-ua-parser-js-0.7.29</strong> result and select <strong>Cxbd45c2b9-4622</strong></p>

    <p><img src="./assets/images/ua-parser.png" alt="ua-parser" title="ua-parser" /></p>
  </li>
  <li>
    <p>Reviewing the malicious package description, we can see that ua-parser-js had three versions published with malicious code.  The three affected versions (0.7.29, 0.8.0, and 1.0.0) were the result of an account takeover, otherwise known as <strong>Repojacking</strong>.  We can see in the remediation advice that we can upgrade to version 0.7.30 to ensure we are not importing an affected version.</p>
  </li>
  <li>
    <p>Click on “Upgrade to Version,” and the Checkmarx plugin will automatically update our package version within package.json to 0.7.30</p>

    <p><img src="./assets/images/ua-parser-fix.png" alt="&quot;ua-parser-fix" title="ua-parser-fix" /></p>
  </li>
</ol>

<h2 id="key-takeaways">Key Takeaways</h2>

<ul>
  <li>Supply Chain Security (SCS) results are included in Checkmarx SCA results</li>
  <li>Unlike vulnerabilities where we have CVEs, malicious packages don’t have a standardized identifier</li>
  <li>Supply Chain Attacks can be surprisingly unsophisticated, but easily incorporated</li>
  <li>The Checkmarx VS Code plugin allows for auto-remediation of specific package versions</li>
</ul>
